# ___WB Work Bot___ 

<font size = 2><i> Developed by [Malakhov Stas](https://github.com/MalakhovStas) in June 2022</i></font>

___
Телеграм бот для работы с API сайта Wildberries.
___
<a id="ceiling"></a>

### __Установка приложения:__

1. Для установки бота на свой компьютер или сервер клонируйте этот репозиторий командой: 
   <i><span style="color:  #228B22;"> git clone ссылка на репозиторий </span><i>

2. Установите зависимости из файла [requirements.txt](requirements.txt) командой: 
   <i><span style="color:  #228B22;"> pip install -r requirements.txt </span></i>

3. Создайте бота при помощи [BotFather](https://telegram.me/BotFather), полученный токен необходимо указать 
   в переменной [<span style="color:  #228B22;">BOT_TOKEN</span>](.env.template) файла [.env.template](.env.template) 
   вместо текста в кавычках (кавычки оставить).

4. Переменная [<span style="color:  #228B22;">ADMINS</span>](.env.template) в файле [.env.template](.env.template) - это список 
   id пользователей Telegram, которым будут предоставлены права администраторов вашего бота. Чтобы узнать id, необходимо 
   зайти в поисковую строку приложения Telegram и ввести <i><span style="color:  #228B22;">@getmyid_bot</span></i>, 
   активировать первого бота в списке, в ответ он пришлет уникальный id пользователя. Можно не указывать, либо указать 
   позднее, удалив текст и оставив пустые кавычки. 

5. Обязательно необходимо переименовать файл [.env.template](.env.template) в <i><span style="color:  #228B22;">.env
   </span></i> На этом установка завершена, запускайте файл [main.py](main.py) и пользуйтесь вашим приложением.

### __Настройка бота:__

- [config.py](config_data/config.py) - пользовательские настройки, с описанием. 

- [bot_messages](config_data/bot_messages.py) - словарь сообщений для удобства редактирования текста сообщений от бота пользователю 

## __Документация:__

#### bot_messages.py
    BotSays: Класс методов возвращающих значения словаря SAYS сообщений от бота пользователю
   
    Say: Метод извлекает из стека вызовов имя файла (если оно не указано в параметрах), в котором он был вызван и
         использует это имя в качестве первого ключа, если указан key, он используется в качестве второго ключа для
         извлечения значения словаря сообщений от бота пользователю.
        :param key: str | None -> второй параметр составного ключа.
        :param file_name: str | None -> имя первого ключа
        :return: str -> текстовое сообщение от бота пользователю.

#### config.py
    Основные настройки приложения
   
#### database_utility_PgSQL.py
    ORM для работы приложения с БД PostgreSQL
   
#### database_utility_SQLite.py
    ORM для работы приложения с БД SQLite

#### get_first_keyboard.py
    Обработчик обратного вызова с Inline клавиатуры "first_keyboard", отправляет сообщение пользователю в
    зависимости от нажатой кнопки(callback), изменяет состояние пользователя.
#### get_second_keyboard.py
    Обработчик обратного вызова с Inline клавиатуры "second_keyboard", отправляет сообщение пользователю в
    зависимости от нажатой кнопки(callback), изменяет состояние пользователя.
#### help.py
    Обработчик команды(help), отправляет пользователю объяснение работы бота и ссылку на чат поддержки.
#### ref_link.py
    Обработчик команды(ref_link), отправляет пользователю реферальную ссылку
#### reset.py
    Обработчик команды /reset, сбрасывает состояние пользователя, также используется как функция сброса состояния
    в случае исключения в процессе обработки запроса от пользователя.
#### start.py
    Обработчик команды /start, если пользователь не найден в базе данных, записывает его, таким образом
    запускает процесс взаимодействия бота с пользователем.
#### admins_room.py
    Модуль методов доступных только администраторам
#### first_keyboard.py
    Создает и возвращает клавиатуру с двумя кнопками "Реклама в поиске" и "Реклама в карточке", в callback
    ключи для handler
#### second_keyboard.py
    Создает и возвращает клавиатуру с двумя кнопками "Проверить ещё" и "Поддержка", в callback
    ключи для handler
#### access_control.py
    on_pre_process_update: Проверяет права доступа пользователя к приложению записанные в базе данных, если доступ разрешен или
                           пользователь не найден в базе, пропускает сообщение пользователя к дальнейшей обработке, также передаёт далее
                           данные о пользователе полученные из базы данных, предварительно записав их в словарь data.
    
    on_process_update: Контролирует время между сообщениями от пользователя для защиты от 'флуда'

    on_pre_process_message: Контролирует соответствие сообщений от пользователя его состоянию, в случае не соответствия
                            отправляет пользователю сообщение и сбрасывает дальнейшую обработку сообщения.

    on_pre_process_callback_query: Контролирует соответствие нажатия инлайн кнопки пользователем его состоянию, в случае не соответствия
                                   отправляет пользователю сообщение и сбрасывает дальнейшую обработку коллбека.

#### states.py
    Модуль классов состояний

#### exception_control.py
    Декоратор, контролирует выполнение кода в функции, в случае успешного выполнения возвращает результат
    выполнения функции, в случае исключения вызывает функцию reset.func_reset для сброса состояния пользователя
    и возвращает None.

#### admins_send_message.py
    Отправляет сообщения об ошибках и состоянии бота администраторам, если их id указаны в ADMINS.
#### proxi_rotation.py
    Модуль для ротации и карантина прокси, если при вызове функции указан bad_proxi он попадает в карантин на срок,
    указанный в переменной TIME_CARANTIN_PROXI в секундах.
#### referal_system.py
    Реализация реферальной системы доступа к запросам
#### request_api.py
    Запрашивает данные с API сайта(url), в случае успеха возвращает полученное сообщение в виде словаря или списка,
    в противном случае возвращает пустой словарь и отправляет сообщение об ошибке запроса администраторам
#### response_request.py
    Формирует и отравляет ответ на запрос пользователя
#### set_bot_commands.py
    Устанавливает команды в меню бота
#### .env
    Файл с конфиненциальной информацией - токен бота, id администраторов и параметры доступа к PostgreSQL
#### ADS_WB_Bot.service
    Сервис для автоматического запуска бота при перезагрузке сервера - копия должна лежать в папке /etc/systemd/system/ 
#### loader.py
    Модуль настройки загрузки и настройки основных инструментов приложения 
#### main.py
    Модуль запуска приложения.
    start: Запуск бота, в случае 'падения' происходит перезапуск бота количество раз(MAX_RESTART_BOT), при: старте,
           рестарте и отключении бота отправляется сообщение администраторам
#### requirements.txt
    Список установленных библиотек 